#!/bin/sh
bold="$(tput bold)"
normal="$(tput sgr0)"
envname="$1"
envyml="${2:-environment.yml}"
if [ -z "$envname" ]; then
    echo "❌  ${bold}Environment name required, aborting.${normal}"
    exit 1
fi
if [ ! -f "$envyml" ]; then
    echo "❌  ${bold}Environment file ${envyml} not found, aborting.${normal}"
    exit 1
fi
check-long-running-process || exit $?
ensure_mamba env create -n "$envname" -f "$envyml"
status=$?
if [ $status != 0 ] ; then
    echo "❌  ${bold}Could not create environment '${envname}', aborting.${normal}"
    exit 1
fi
. "$CONDA_PREFIX/etc/profile.d/conda.sh"
conda activate "$envname"
status=$?
if [ $status != 0 ] ; then
    echo "❌  ${bold}Could not activate environment '${envname}', aborting.${normal}"
    exit 1
fi
prepare-env "$envyml"
